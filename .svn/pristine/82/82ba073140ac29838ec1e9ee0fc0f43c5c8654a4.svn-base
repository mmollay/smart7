<?php
include ('../config.inc.php');

// Processing the $_POST data
$expectedFields = [ 'update_id','title','text','list_id','kill_all' ]; // Add all expected static keys here
$safePost = [ ];

foreach ( $_POST as $key => $value ) {
	if (in_array ( $key, $expectedFields ) || preg_match ( '/^(lots|info)\d+$/', $key )) {
		// Processing known fields and dynamically generated lots/info fields
		$safePost [$key] = $GLOBALS ['mysqli']->real_escape_string ( $value );
	}
}

// Processing based on 'list_id'
if (isset ( $safePost ['list_id'] )) {
	switch ($safePost ['list_id']) {

		case 'form_home' :
			if ($safePost ['kill_all'])
				echo "ok";
			break;
		case 'group' :

			// Prepared statement for replacing/updating in the strategy_group table
			$stmt = $GLOBALS ['mysqli']->prepare ( "REPLACE INTO ssi_trader.strategy_group SET group_id = ?, title = ?, text = ?" );
			$stmt->bind_param ( "iss", $safePost ['update_id'], $safePost ['title'], $safePost ['text'] );
			$stmt->execute ();
			$group_id = $stmt->insert_id;
			$stmt->close ();

			// Deleting existing strategies for the group
			$deleteStmt = $GLOBALS ['mysqli']->prepare ( "DELETE FROM ssi_trader.strategy WHERE group_id = ?" );
			$deleteStmt->bind_param ( "i", $group_id );
			$deleteStmt->execute ();
			$deleteStmt->close ();

			for($i = 1; $i < 10; $i ++) {
				$lotsVarName = "lots" . $i;
				$infoVarName = "info" . $i;

				// Accessing the values of lots and info from $safePost
				$lotsValue = isset ( $safePost [$lotsVarName] ) ? $safePost [$lotsVarName] : null;
				$infoValue = isset ( $safePost [$infoVarName] ) ? $safePost [$infoVarName] : '';

				if ($lotsValue) {
					// Prepared statement for inserting into the strategy table
					$insertStmt = $GLOBALS ['mysqli']->prepare ( "INSERT INTO ssi_trader.strategy SET group_id = ?, level = ?, lots = ?, info = ?" );
					$insertStmt->bind_param ( "iids", $group_id, $i, $lotsValue, $infoValue );
					$insertStmt->execute ();
					$insertStmt->close ();
				}
			}

			echo "ok";
			break;
	}
}

