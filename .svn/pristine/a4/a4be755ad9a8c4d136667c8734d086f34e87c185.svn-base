<?php
include ('../config.inc.php');

// Processing the $_POST data
$expectedFields = [ 'update_id','title','text','list_id','form_id','strategy_id' ]; // Add all expected static keys here
$safePost = [ ];

foreach ( $_POST as $key => $value ) {
	if (in_array ( $key, $expectedFields ) || preg_match ( '/^(lots|info|entrypoint|takeprofit)\d+$/', $key )) {
		// Processing known fields and dynamically generated lots/info fields
		$safePost [$key] = $GLOBALS ['mysqli']->real_escape_string ( $value );
	}
}

if (isset($safePost ['form_id'])) {

	switch ($safePost ['form_id']) {
		case 'form_setting':
			// Prepared statement for replacing/updating in the strategy_group table
			$stmt = $GLOBALS ['mysqli']->prepare ( "REPLACE INTO ssi_trader.setting SET setting_id = ?, title = ?, strategy_id = ? " );
			$stmt->bind_param ( "iss", $safePost ['update_id'], $safePost ['title'], $safePost ['strategy_id'] );
			$stmt->execute ();
			$setting_id = $stmt->insert_id;
			
			$stmt->close ();
			break;

		case 'form_home' :
			if ($safePost ['kill_all'])
				echo "ok";
			break;
		}
}

// Processing based on 'list_id'
if (isset ( $safePost ['list_id'] )) {
	switch ($safePost ['list_id']) {
	
		case 'hedging' :

			// Prepared statement for replacing/updating in the strategy_group table
			$stmt = $GLOBALS ['mysqli']->prepare ( "REPLACE INTO ssi_trader.hedging_group SET group_id = ?, title = ?, text = ?" );
			$stmt->bind_param ( "iss", $safePost ['update_id'], $safePost ['title'], $safePost ['text'] );
			$stmt->execute ();
			$group_id = $stmt->insert_id;
			$stmt->close ();

			// Deleting existing hedgings for the group
			$deleteStmt = $GLOBALS ['mysqli']->prepare ( "DELETE FROM ssi_trader.hedging WHERE group_id = ?" );
			$deleteStmt->bind_param ( "i", $group_id );
			$deleteStmt->execute ();
			$deleteStmt->close ();

			for($i = 1; $i < 14; $i ++) {
				$lotsVarName = "lots" . $i;
				$infoVarName = "info" . $i;
				$entrypointVarName = "entrypoint" . $i;
				$takeprofitVarName = "takeprofit" . $i;

				// Accessing the values of lots and info from $safePost
				$lotsValue = isset ( $safePost [$lotsVarName] ) ? $safePost [$lotsVarName] : null;
				$entrypointValue = isset ( $safePost [$entrypointVarName] ) ? $safePost [$entrypointVarName] : null;
				$takeprofitValue = isset ( $safePost [$takeprofitVarName] ) ? $safePost [$takeprofitVarName] : null;
				$infoValue = isset ( $safePost [$infoVarName] ) ? $safePost [$infoVarName] : '';

				if ($lotsValue) {
					
					// Prepared statement for inserting into the hedging table
					$insertStmt = $GLOBALS ['mysqli']->prepare ( "INSERT INTO ssi_trader.hedging SET group_id = ?, level = ?, lots = ?, entrypoint = ?, takeprofit = ?, info = ?" );
					$insertStmt->bind_param ( "iissss", $group_id, $i, $lotsValue, $entrypointValue, $takeprofitValue, $infoValue );
					$insertStmt->execute ();
					$insertStmt->close ();
				}
			}

			echo "ok";
			break;
	}
}

