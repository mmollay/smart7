

$(document).ready(() => {
	loadEmaForm();
	updateProfits(); // Initialer Aufruf, um die Profite beim Laden der Seite zu aktualisieren
});

// Aktualisiere die Profite alle 5 Minuten
setInterval(updateProfits, 300000); // 300000ms = 5 Minuten

function updateProfits() {
	$.ajax({
		url: 'inc/getDailyProfit.php',
		type: 'GET',
		dataType: 'json',
		success: function (servers) {
			servers.forEach(function (server) {
				$('#server-profit-' + server.server_id).text(server.daily_profit + 'â‚¬');
			});
		},
		error: function (xhr, status, error) {
			console.error("Ein Fehler ist aufgetreten: " + error);
		}
	});
}


// Globale Variable, um den letzten Update-Zeitpunkt zu speichern
let lastUpdateTime = 0;

function updateDaxValue(data) {
	const now = Date.now();

	if (now - lastUpdateTime >= 1000) {
		try {
			const parsedData = JSON.parse(data);
			if (parsedData.SYMBOL === "GER30") {
				$('#daxValue').fadeOut('fast', () => {
					$(this).text(parsedData.ASK).fadeIn('fast');
				});

				lastUpdateTime = now;
			}
		} catch (e) {
			console.error('Error parsing message:', e);
		}
	}
}

function post_ema(strategyValue, strategy, server_id) {
	console.log(strategyValue);

	$.ajax({
		url: 'ajax/post.php',
		type: 'POST',
		data: { strategy_value: strategyValue, strategy: strategy, server_id: server_id },
		success: (data) => {
			after_post_ema(data);
			loadEmaForm();
		},
		error: (xhr, status, error) => {
			showToast(`Ein Fehler ist aufgetreten: ${error}`, 'error');
		}
	});
}

function loadEmaForm() {
	$('#formEmaContainer .dimmer').addClass('active');
	$.ajax({
		url: 'inc/ema_form.php',
		type: 'GET',
		success: (data) => {
			$('#formEmaContainer .dimmer').removeClass('active');
			$('#formEmaContainer').html(data);
		},
		error: (err) => {
			$('#formEmaContainer .dimmer').removeClass('active');
			console.error('Fehler beim Laden der Daten:', err);
			$('#formEmaContainer').html('<div class="ui error message">Fehler beim Laden des Inhalts.</div>');
		}
	});
}

function after_post_ema(json) {
	console.log(json);

	try {
		json = JSON.parse(json);
	} catch (e) {
		showToast('Fehler bei der Verarbeitung der Antwort.', 'error');
		return;
	}

	if (json.error) {
		showToast(json.error, 'error');
	} else {
		showToast(json.message, 'info');
	}
}


function after_start_strategy(json) {
	after_post_ema(json);
	loadEmaForm();
}

