<?php
session_start();

//http://deineDomain.de/fetch_stock.php?token=52a36a36e2e6da849685b71f466dde56

// für cronjob  
//* * * * * php /var/www/ssi/smart7/ssi_trader/exec/fetch_stock.php 52a36a36e2e6da849685b71f466dde56

define('SECRET_TOKEN', '52a36a36e2e6da849685b71f466dde56'); // Dein geheimer Token

// Funktion, um den Token zu überprüfen
function validateToken($token)
{
    return $token === SECRET_TOKEN;
}

// Ermitteln des Ausführungskontextes und des Tokens
if (php_sapi_name() === 'cli') {
    // Ausführung über CLI (Kommandozeile)
    $token = $argc > 1 ? $argv[1] : null; // argv[1] ist das erste Kommandozeilenargument
} else {
    // Ausführung über den Webserver (z.B. Browseraufruf)
    $token = isset($_GET['token']) ? $_GET['token'] : null; // $_GET['token'] ist der GET-Parameter "token"
}

// Token-Validierung
if (validateToken($token)) {
    // Token ist gültig, führe deine Logik hier aus
    // echo "Token ist gültig. Führe Aufgabe aus...";
    // Dein vorhandenes Skript zur Datenabfrage und -einspielung hier
} else {
    die("Unbefugter Zugriff! Falscher oder fehlender Token.");
}

include(__DIR__ . "/../functions.php");
include(__DIR__ . "/../config_db.php");

// Datenbankverbindung aufbauen
$sql_server = $cfg_mysql['server'];
$sql_user = $cfg_mysql['user'];
$sql_pass = $cfg_mysql['password'];
$sql_db = $cfg_mysql['db'];

$mysqli = mysqli_connect($sql_server, $sql_user, $sql_pass, $sql_db);

//Wird nicht benötigt, da die Daten immer vom gleichen Server abgeholt werden
//$url = getSingleServerIpByUserId($mysqli, $_SESSION['user_id']);
$url = 'http://85.215.176.20:8080';

// EMA Print Daten abrufen
$url .= '/emaPrint';

$jsonString = sendCurlRequest($url);
$jsonArray = json_decode($jsonString, true);

if (!$mysqli) {
    die("Verbindung fehlgeschlagen: " . mysqli_connect_error());
}

// SQL-Statement vorbereiten
$query = "INSERT INTO `stocks_data` (`buy`, `sell`, `time`, `price`) VALUES (?, ?, ?, ?)";
$stmt = mysqli_prepare($mysqli, $query);

if (!$stmt) {
    die("Fehler bei der Vorbereitung des Statements: " . mysqli_error($mysqli));
}

// Parameter binden und Query ausführen
mysqli_stmt_bind_param($stmt, "iiss", $jsonArray['buy'], $jsonArray['sell'], $jsonArray['time'], $jsonArray['price']);

if (mysqli_stmt_execute($stmt)) {
    echo "Datensatz erfolgreich eingefügt.";
} else {
    echo "Fehler: " . mysqli_stmt_error($stmt);
}

// Ressourcen freigeben
mysqli_stmt_close($stmt);
mysqli_close($mysqli);
