<?php
// Beispiel für die Verwendung der Funktion
$connection = new mysqli($cfg_mysql['server'], $cfg_mysql['user'], $cfg_mysql['password'], $cfg_mysql['db']);

// Rufe die Funktion auf, um das Array für die Jahre zu erhalten
$yearsDropdownArray = getUniqueYearsForDropdown($connection);

$array_filter_month = array(
    'MONTH(FROM_UNIXTIME(time)) = 1' => 'Jänner',
    'MONTH(FROM_UNIXTIME(time)) = 2' => 'Februar',
    'MONTH(FROM_UNIXTIME(time)) = 3' => 'März',
    'MONTH(FROM_UNIXTIME(time)) = 4' => 'April',
    'MONTH(FROM_UNIXTIME(time)) = 5' => 'Mai',
    'MONTH(FROM_UNIXTIME(time)) = 6' => 'Juni',
    'MONTH(FROM_UNIXTIME(time)) = 7' => 'Juli',
    'MONTH(FROM_UNIXTIME(time)) = 8' => 'August', // Korrektur der Schreibweise
    'MONTH(FROM_UNIXTIME(time)) = 9' => 'September',
    'MONTH(FROM_UNIXTIME(time)) = 10' => 'Oktober',
    'MONTH(FROM_UNIXTIME(time)) = 11' => 'November',
    'MONTH(FROM_UNIXTIME(time)) = 12' => 'Dezember'
);

// Initialize the array with the "Current Year" filter
$array_filter_time_periods = [
    'YEAR(FROM_UNIXTIME(time)) = ' . date('Y') => 'Current Year',
];

// Existing filters for specific time periods
$array_filter_time_periods += [
    'DATE(FROM_UNIXTIME(time)) = CURDATE()' => 'Today',
    'DATE(FROM_UNIXTIME(time)) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)' => 'Yesterday',
    'DATE(FROM_UNIXTIME(time)) = DATE_SUB(CURDATE(), INTERVAL 2 DAY)' => 'Day Before Yesterday',
    'YEARWEEK(FROM_UNIXTIME(time), 1) = YEARWEEK(CURDATE(), 1) - 1' => 'Last Week',
    'MONTH(FROM_UNIXTIME(time)) = MONTH(CURDATE()) - 1 AND YEAR(FROM_UNIXTIME(time)) = YEAR(CURDATE())' => 'Last Month',
];

// Add filters for the last six months, including the year
for ($i = 1; $i <= 6; $i++) {
    $monthYear = date('F Y', strtotime("-$i month"));
    $month = date('m', strtotime("-$i month"));
    $year = date('Y', strtotime("-$i month"));

    // Generate the SQL condition
    $condition = "MONTH(FROM_UNIXTIME(time)) = $month AND YEAR(FROM_UNIXTIME(time)) = $year";

    // Add month and year to the display text
    $array_filter_time_periods[$condition] = $monthYear;
}


$arr['mysql'] = [
    'table' => 'ssi_trader.orders AS o LEFT JOIN ssi_trader.symbols AS s ON o.symbol_id = s.symbol_id', // Alias 'o' für die Tabelle orders
    'field' => "o.ticket, o.order_id, o.time, o.time_msc, o.type, o.entry, o.magic, o.position_id, o.reason, o.volume, 
                o.price, o.commission, o.swap, o.profit, o.fee, o.symbol_id, 
                FROM_UNIXTIME(o.time) AS readable_time, 
                FROM_UNIXTIME(o.time_msc/1000) AS readable_time_msc,
                s.symbol", // Hinzufügen von s.symbol_name zur Feldliste
    'order' => 'o.time DESC', // Sortierung nach 'time' in orders
    'limit' => 50,
    'group' => 'o.ticket', // Gruppierung nach 'ticket' in orders
];

//$arr['filter']['select_year'] = array('type' => 'dropdown', 'array' => $yearsDropdownArray, 'placeholder' => 'Alle Jahre', 'query' => "{value}");
//$arr['filter']['select_month'] = array('type' => 'dropdown', 'query' => "{value}", 'array' => $array_filter_month, 'placeholder' => '--Alle Monate--');
$arr['filter']['select_day'] = array('type' => 'dropdown', 'query' => "{value}", 'array' => $array_filter_time_periods, 'placeholder' => '--Timer period--', 'default_value' => 'DATE(FROM_UNIXTIME(time)) = CURDATE()');

$arr['order'] = array('default' => 'position_id desc', 'array' => array('position_id desc' => 'Position', 'time desc' => 'Time', 'profit desc' => 'Profit'));

$arr['list'] = [
    'id' => 'orders',
    'width' => '1000px',
    'size' => 'small',
    'class' => 'compact celled striped'
];

// Hinzufügen von Spaltenüberschriften basierend auf der Tabelle `orders`
$arr['th']['position_id'] = ['title' => "Position ID", 'width' => '100px'];
$arr['th']['symbol'] = ['title' => "Symbol ID", 'width' => '100px'];
$arr['th']['price'] = ['title' => "Price", 'format' => 'number_color', 'align' => 'right', 'width' => '120px'];
//$arr['th']['order_id'] = ['title' => "Order", 'width' => '100px'];
$arr['th']['type'] = ['title' => "Type", 'replace' => array('default' => '', '1' => "<span class='ui red text'>buy</span>", '0' => "<span class='ui blue text'>sell</span>"), 'align' => 'center', 'width' => '50px'];
$arr['th']['entry'] = ['title' => "Entry", 'format' => 'number', 'align' => 'right', 'width' => '120px'];
$arr['th']['volume'] = ['title' => "Volume"];
$arr['th']['readable_time'] = ['title' => "Time"];
$arr['th']['profit'] = ['title' => "Profit", 'format' => 'number_redblue', 'align' => 'right', 'total' => true, 'width' => '120px'];
// $arr['th']['readable_time_msc'] = ['title' => "Readable Time (msc)", 'align' => 'center'];
// $arr['th']['time'] = ['title' => "Time", 'align' => 'center'];
// $arr['th']['time_msc'] = ['title' => "Time (msc)", 'align' => 'center'];
// $arr['th']['magic'] = ['title' => "Magic"];
// $arr['th']['reason'] = ['title' => "Reason"];
// $arr['th']['commission'] = ['title' => "Commission"];
//$arr['th']['swap'] = ['title' => "Swap"];
//$arr['th']['ticket'] = ['title' => "Ticket"];
// $arr['th']['fee'] = ['title' => "Fee"];

function getUniqueYearsForDropdown($connection)
{
    $yearsArray = [];

    // SQL-Abfrage vorbereiten
    $query = "SELECT DISTINCT YEAR(FROM_UNIXTIME(time)) AS year FROM orders ORDER BY year DESC";

    // Führe die Abfrage aus
    $result = $connection->query($query);

    // Überprüfe, ob die Abfrage erfolgreich war
    if ($result) {
        // Hole alle einzigartigen Jahre und fülle das Array
        while ($row = $result->fetch_assoc()) {
            // Der Schlüssel und Wert sind hier gleich, da keine spezifische Bedingung benötigt wird
            $yearsArray["YEAR(FROM_UNIXTIME(time)) = " . $row['year']] = $row['year'];
        }

        // Gib das Ergebnis frei
        $result->free();
    } else {
        // Fehlerbehandlung
        echo "Fehler bei der Abfrage: " . $connection->error;
    }

    return $yearsArray;
}

function getWeeksArray()
{
    $weeksArray = [];
    $currentTimestamp = time(); // Aktueller Zeitpunkt

    for ($i = 0; $i <= 5; $i++) {
        // Berechne den Start- und Endzeitpunkt jeder Woche
        $startOfWeek = strtotime("Monday this week - $i week");
        $endOfWeek = strtotime("Sunday this week - $i week");

        // Formatierung für die Anzeige
        $display = date('Y-m-d', $startOfWeek) . " bis " . date('Y-m-d', $endOfWeek);

        // Formatierung für die SQL-Abfrage
        $condition = "time >= " . $startOfWeek . " AND time <= " . $endOfWeek;

        // Füge den Eintrag zum Array hinzu
        $weeksArray[$condition] = $display;
    }

    return $weeksArray;
}

function getWeeksFilterArray()
{
    $weeksArray = [];
    $currentWeekNumber = date('W');
    $currentYear = date('Y');

    for ($i = 0; $i <= 6; $i++) {
        // Berechne die Woche und das Jahr, falls die Woche ins vorherige Jahr fällt
        $weekNumber = $currentWeekNumber - $i;
        $year = $currentYear;
        if ($weekNumber <= 0) {
            $weekNumber += 52;
            $year -= 1;
        }

        // Erstelle die SQL-Bedingung
        $condition = sprintf("YEAR(FROM_UNIXTIME(time)) = %d AND WEEK(FROM_UNIXTIME(time), 1) = %d", $year, $weekNumber);

        // Berechne den lesbaren Zeitraum für die Anzeige
        $startOfWeek = strtotime($year . "W" . str_pad($weekNumber, 2, '0', STR_PAD_LEFT));
        $endOfWeek = strtotime("+6 days", $startOfWeek);
        $display = "Woche vom " . date('Y-m-d', $startOfWeek) . " bis " . date('Y-m-d', $endOfWeek);

        // Füge den Eintrag zum Array hinzu
        $weeksArray[$condition] = $display;
    }

    return $weeksArray;
}


