<?php
$arr['ajax'] = array('success' => "after_form_broker(data)", 'dataType' => "html");
// $arr['tab'] = array('tabs' => array(1 => 'Default', 2 => 'More'), 'active' => '1');
$arr['sql'] = array('query' => "SELECT * from ssi_trader.broker WHERE broker_id  = '{$_POST['update_id']}'");
$arr['field']['broker_server'] = array('tab' => '1', 'type' => 'input', 'label' => 'Broker-Server', 'focus' => true);
$arr['field']['user'] = array('tab' => '1', 'type' => 'input', 'label' => 'Account');
$arr['field']['password'] = array('tab' => '1', 'type' => 'password', 'label' => 'Password');

// SQL-Basisabfrage
$sql = "
SELECT s.server_id, CONCAT(s.name, ' (', s.url, ')') AS name
FROM ssi_trader.servers AS s ";

// Bedingungen basierend auf der Verfügbarkeit von 'update_id' hinzufügen
if ($_POST['update_id']) {
    $sql .= "
    LEFT JOIN ssi_trader.broker AS b ON s.server_id = b.server_id AND b.broker_id != " . $_POST['update_id'] . "
    WHERE b.server_id IS NULL
        OR s.server_id IN (
            SELECT b.server_id
            FROM ssi_trader.broker AS b
            WHERE b.broker_id = " . $_POST['update_id'] . "
        )";
} else {
    $sql .= "
    WHERE s.server_id NOT IN (
        SELECT b.server_id
        FROM ssi_trader.broker AS b
        WHERE b.server_id IS NOT NULL
    )";
}

$sql .= " ORDER BY s.name ASC";

$arr['field']['server_id'] = array(
    'tab' => '1',
    'type' => 'dropdown',
    'label' => 'Windows-Server',
    'array_mysql' => $sql,

    'text' => 'name', // Spezifiziert, welches Feld als Text im Dropdown angezeigt werden soll
    'class' => 'fluid search selection'
);

$add_js .= "<script type=\"text/javascript\" src=\"js/form_broker.js\"></script>";
