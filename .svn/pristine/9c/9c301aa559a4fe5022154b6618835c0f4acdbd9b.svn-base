<?php
include(__DIR__ . '/../config.inc.php');

if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    // Konvertiere 'qty' zu einem Float, falls es gesetzt ist
    if (isset($_POST['qty'])) {
        $_POST['qty'] = floatval($_POST['qty']);
    }

    if (isset($_POST['price'])) {
        $_POST['price'] = floatval($_POST['price']);
    }

    // Setze 'qty' auf 0.1, falls der Wert kleiner als 0 ist
    if ($_POST['qty'] < 0) {
        $_POST['qty'] = 0.1;
    }

    $server_id = $_POST['server_id'];
    $token = $_SESSION['token'][$server_id];

    $result = getServerIdGetUrl($mysqli, $server_id);
    if ($result["success"]) {
        // Erfolg - verarbeite die gefundene URL
        $url = $result["url"];
    } else {
        $url = getSingleServerIpByUserId($mysqli, $_SESSION['user_id']);
    }

    // Überprüfung, welche Aktion ausgeführt werden soll
    switch (true) {
        case($_POST['strategy_value'] == 'startMT5'):
            $data = getMT5BrokerData($mysqli, $server_id);
            //print_r($data);
            $url .= '/startMT5';
            break;
        case($_POST['strategy_value'] == 'stopMT5'):
            $url .= '/stopMT5';
            break;
        //start Strategy
        case($_POST['strategy_value'] == 'startStrategy'):
            $url .= '/startStrategy';
            //$url .= "/start" . $_POST['strategy'];
            $size = floatval($_POST['size']);
            $data = array('strategy' => $_POST['strategy'], 'size' => $size);
            break;
        //stop Strategy
        case($_POST['strategy_value'] == 'stopStrategy'):
            $url .= '/stopStrategy';
            //$url .= "/stop" . $_POST['strategy'];
            $data = array('strategy' => $_POST['strategy']);

            break;
        //pause Strategy
        case($_POST['strategy_value'] == 'pauseStrategy'):
            $url .= '/pauseStrategy';
            $data = array('strategy' => $_POST['strategy']);

            break;
        //cancel
        case($_POST['cancel_close_all'] == 'cancelAll'):
            $url .= '/cancelAll';
            break;
        //close
        case($_POST['cancel_close_all'] == 'closeAll'):
            $url .= '/closeAll';
            $data = '';
            break;
        //killall
        case($_POST['kill_all'] == 1):
            $url .= '/panic';
            break;
        case($_POST['buy_sell'] == 'sell'):
            $url .= '/sellMarket';
            $data = array('qty' => $_POST['qty']);
            break;
        case($_POST['buy_sell'] == 'buy'):
            $url .= '/buyMarket';
            $data = array('qty' => $_POST['qty']);
            break;
        case($_POST['buy_sell_stop'] == 'buyStop'):
            $url .= '/buyStop';
            $data = array('qty' => $_POST['qty'], 'price' => $_POST['price']);
            break;
        case($_POST['buy_sell_stop'] == 'sellStop'):
            $url .= '/sellStop';
            $data = array('qty' => $_POST['qty'], 'price' => $_POST['price']);
            break;
        case($_POST['buy_sell_limit'] == 'buyLimit'):
            $url .= '/buyLimit';
            $data = array('qty' => $_POST['qty'], 'price' => $_POST['price']);
            break;
        case($_POST['buy_sell_limit'] == 'sellLimit'):
            $url .= '/sellLimit';
            $data = array('qty' => $_POST['qty'], 'price' => $_POST['price']);
            break;
    }



    // Sende den ersten Request
    $jsonString = sendCurlRequest($url, $data, $token);

    echo $jsonString;
}

// [GIN] 2024/02/27 - 11:41:22 | 200 |      7.3353ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:02 | 200 |      7.7385ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:02 | 200 |      6.1337ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:09 | 200 |      8.4122ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:09 | 200 |      6.0034ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:19 | 200 |            0s | 217.149.170.223 | GET      "/"
// [GIN] 2024/02/27 - 11:42:19 | 200 |      8.4813ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:19 | 200 |      6.3417ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:21 | 200 |      5.9331ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:21 | 200 |      5.5287ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:24 | 200 |            0s | 217.149.170.223 | GET      "/"
// [GIN] 2024/02/27 - 11:42:24 | 200 |      8.8624ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:24 | 200 |      6.5775ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:26 | 200 |       5.921ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:26 | 200 |      5.8776ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:33 | 500 |     13.8412ms | 217.149.170.223 | GET      "/stopMT5"
// [GIN] 2024/02/27 - 11:42:33 | 200 |      6.6556ms | 217.149.170.223 | GET      "/getMT5Status"
// 2024/02/27 11:42:36 python realServer.py executed successfully with account:  josef  password:  test  server:  BlackBullMarkets-Demo
// [GIN] 2024/02/27 - 11:42:36 | 200 |     19.1934ms | 217.149.170.223 | POST     "/startMT5"
// [GIN] 2024/02/27 - 11:42:36 | 200 |      4.9951ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:36 | 200 |      6.6166ms | 217.149.170.223 | GET      "/getActiveStrategies"
// [GIN] 2024/02/27 - 11:42:38 | 200 |            0s | 217.149.170.223 | GET      "/"
// [GIN] 2024/02/27 - 11:42:38 | 200 |       8.446ms | 217.149.170.223 | GET      "/getMT5Status"
// [GIN] 2024/02/27 - 11:42:38 | 200 |      6.8198ms | 217.149.170.223 | GET      "/getActiveStrategies"


// /startStrategy array('strategy':'Martin', 'size':'0.1');
// /pauseStrategy array('strategy':'Martin');
// /stopStrategy array('strategy':'Martin');